<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 轉 PPTX 轉換工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        h1 i {
            font-size: 2.2rem;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }
        
        main {
            padding: 30px;
        }
        
        .upload-section {
            border: 3px dashed #4b6cb7;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            background-color: #f8fafd;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            background-color: #edf2ff;
            border-color: #3a56a5;
        }
        
        .upload-section.dragover {
            background-color: #e1e9ff;
            border-color: #2d4485;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4b6cb7;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            display: inline-block;
            background: linear-gradient(to right, #4b6cb7, #3a56a5);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            margin-top: 15px;
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(75, 108, 183, 0.3);
        }
        
        .file-info {
            margin-top: 20px;
            font-size: 1rem;
            color: #555;
        }
        
        #fileInput {
            display: none;
        }
        
        .preview-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #182848;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeef5;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 8px;
            background-color: #f8fafd;
        }
        
        .page-preview {
            width: 150px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .page-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #eaeef5;
        }
        
        .page-number {
            padding: 8px;
            text-align: center;
            font-weight: 600;
            color: #4b6cb7;
            background-color: white;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #4b6cb7, #3a56a5);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(75, 108, 183, 0.3);
        }
        
        .btn-secondary {
            background-color: #f0f3f9;
            color: #4b6cb7;
            border: 2px solid #4b6cb7;
        }
        
        .btn-secondary:hover {
            background-color: #e1e9ff;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .progress-container {
            margin-top: 30px;
            display: none;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #eaeef5;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4b6cb7, #3a56a5);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #4b6cb7;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }
        
        .status.success {
            background-color: #e7f7ef;
            color: #2a8c5e;
            border: 1px solid #a8e6c3;
        }
        
        .status.error {
            background-color: #fde8e8;
            color: #c53030;
            border: 1px solid #fbb6b6;
        }
        
        .status.info {
            background-color: #e8f4fd;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #666;
            font-size: 0.9rem;
            padding: 20px;
            border-top: 1px solid #eaeef5;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            main {
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-file-powerpoint"></i> PDF 轉 PPTX 轉換工具</h1>
            <p class="subtitle">上傳多頁 PDF 文件，自動轉換為每頁都是圖片的 PowerPoint 簡報檔案。完全在瀏覽器中處理，您的文件不會上傳到任何伺服器。</p>
        </header>
        
        <main>
            <section class="upload-section" id="dropArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h2>上傳 PDF 檔案</h2>
                <p>將您的 PDF 檔案拖放到此區域，或點擊下方按鈕選擇檔案</p>
                <input type="file" id="fileInput" accept=".pdf">
                <button class="upload-btn" id="browseBtn">
                    <i class="fas fa-folder-open"></i> 選擇 PDF 檔案
                </button>
                <div class="file-info" id="fileInfo">
                    尚未選擇檔案
                </div>
            </section>
            
            <section class="preview-section" id="previewSection" style="display: none;">
                <h3 class="section-title"><i class="fas fa-images"></i> PDF 頁面預覽（最多顯示50頁）</h3>
                <div class="preview-container" id="previewContainer">
                    <!-- PDF 頁面預覽將在此處動態生成 -->
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-trash-alt"></i> 清除檔案
                    </button>
                    <button class="btn btn-primary" id="convertBtn">
                        <i class="fas fa-magic"></i> 開始轉換為 PPTX
                    </button>
                </div>
            </section>
            
            <div class="progress-container" id="progressContainer">
                <h3 class="section-title"><i class="fas fa-spinner fa-spin"></i> 轉換進度</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">準備轉換...</div>
            </div>
            
            <div class="status" id="statusMessage"></div>
        </main>
        
        <footer>
            <p>本工具完全在瀏覽器中運行，不會將您的文件上傳到任何伺服器，確保資料安全。</p>
            <p>支援最多200頁PDF轉換，超大檔案建議分批處理以獲得最佳效能</p>
            <p>使用 PDF.js、jsPDF、html2canvas 和 PptxGenJS 技術開發</p>
        </footer>
    </div>

    <script>
        // 全域變數
        let pdfDocument = null;
        let pdfImages = [];
        let fileName = "";
        
        // 設定常數
        const MAX_PREVIEW_PAGES = 50; // 預覽最多顯示50頁
        const MAX_PDF_SIZE = 100 * 1024 * 1024; // 最大PDF檔案大小100MB
        
        // DOM 元素
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const dropArea = document.getElementById('dropArea');
        const fileInfo = document.getElementById('fileInfo');
        const previewSection = document.getElementById('previewSection');
        const previewContainer = document.getElementById('previewContainer');
        const clearBtn = document.getElementById('clearBtn');
        const convertBtn = document.getElementById('convertBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statusMessage = document.getElementById('statusMessage');
        
        // 事件監聽器
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        clearBtn.addEventListener('click', clearFile);
        convertBtn.addEventListener('click', convertToPPTX);
        
        // 拖放功能
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        // 處理檔案選擇
        function handleFileSelect() {
            if (!fileInput.files.length) return;
            
            const file = fileInput.files[0];
            fileName = file.name.replace('.pdf', '');
            
            // 驗證檔案類型
            if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
                showStatus('請選擇有效的 PDF 檔案', 'error');
                return;
            }
            
            // 檢查檔案大小
            if (file.size > MAX_PDF_SIZE) {
                showStatus(`檔案過大（超過${formatFileSize(MAX_PDF_SIZE)}），建議壓縮後再上傳`, 'error');
                fileInput.value = '';
                return;
            }
            
            fileInfo.textContent = `已選擇: ${file.name} (${formatFileSize(file.size)})`;
            loadPDF(file);
        }
        
        // 載入 PDF
        async function loadPDF(file) {
            try {
                showStatus('正在載入 PDF 檔案...', 'info');
                
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                pdfDocument = await loadingTask.promise;
                
                // 顯示總頁數資訊
                const pageCount = pdfDocument.numPages;
                fileInfo.textContent += `，共 ${pageCount} 頁`;
                
                // 顯示預覽區
                previewSection.style.display = 'block';
                
                // 生成頁面預覽
                await generatePreviews();
                
                showStatus(`PDF 載入成功！共 ${pageCount} 頁，現在可以開始轉換。`, 'success');
                
                // 如果頁數很多，給予提示
                if (pageCount > 100) {
                    showStatus('注意：PDF 頁數較多，轉換可能需要較長時間，請耐心等待', 'info');
                }
                
            } catch (error) {
                console.error('載入 PDF 失敗:', error);
                showStatus('載入 PDF 檔案失敗，請確認檔案格式正確', 'error');
            }
        }
        
        // 生成 PDF 頁面預覽
        async function generatePreviews() {
            previewContainer.innerHTML = '';
            pdfImages = [];
            
            // 限制預覽頁數，避免效能問題
            const pageCount = Math.min(pdfDocument.numPages, MAX_PREVIEW_PAGES);
            
            for (let i = 1; i <= pageCount; i++) {
                try {
                    const page = await pdfDocument.getPage(i);
                    
                    // 設定渲染選項（較低解析度用於預覽）
                    const viewport = page.getViewport({ scale: 0.25 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // 渲染頁面到 canvas
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    // 將 canvas 轉為圖片 URL
                    const imgUrl = canvas.toDataURL('image/jpeg', 0.7);
                    pdfImages.push(imgUrl);
                    
                    // 建立預覽元素
                    const pagePreview = document.createElement('div');
                    pagePreview.className = 'page-preview';
                    pagePreview.innerHTML = `
                        <img src="${imgUrl}" alt="PDF 第 ${i} 頁">
                        <div class="page-number">第 ${i} 頁</div>
                    `;
                    
                    previewContainer.appendChild(pagePreview);
                    
                    // 釋放記憶體
                    page.cleanup();
                    canvas.width = 0;
                    canvas.height = 0;
                    
                } catch (error) {
                    console.error(`預覽第 ${i} 頁失敗:`, error);
                    // 建立錯誤預覽元素
                    const pagePreview = document.createElement('div');
                    pagePreview.className = 'page-preview';
                    pagePreview.innerHTML = `
                        <img src="" alt="預覽載入失敗" style="background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">
                        <div class="page-number">第 ${i} 頁 (載入失敗)</div>
                    `;
                    previewContainer.appendChild(pagePreview);
                }
                
                // 每處理5頁稍微暫停一下，避免UI卡頓
                if (i % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            // 如果實際頁數超過預覽限制，顯示提示
            if (pdfDocument.numPages > MAX_PREVIEW_PAGES) {
                const infoMsg = document.createElement('div');
                infoMsg.style.cssText = 'width: 100%; text-align: center; padding: 10px; color: #666; font-style: italic;';
                infoMsg.textContent = `... 還有 ${pdfDocument.numPages - MAX_PREVIEW_PAGES} 頁未顯示`;
                previewContainer.appendChild(infoMsg);
            }
        }
        
        // 轉換為 PPTX - 優化版本，支援更多頁數
        async function convertToPPTX() {
            if (!pdfDocument) {
                showStatus('請先上傳 PDF 檔案', 'error');
                return;
            }
            
            try {
                // 顯示進度條
                progressContainer.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = '準備轉換...';
                
                // 禁用按鈕
                convertBtn.disabled = true;
                clearBtn.disabled = true;
                
                // 建立 PPTX
                const pptx = new PptxGenJS();
                
                // 設定簡報屬性
                pptx.title = fileName;
                pptx.subject = '從 PDF 轉換的簡報';
                pptx.author = 'PDF 轉 PPTX 工具';
                
                // 轉換每一頁
                const totalPages = pdfDocument.numPages;
                let successPages = 0;
                let failedPages = 0;
                
                // 檢查頁數，如果太多給予提示
                if (totalPages > 100) {
                    showStatus('注意：PDF 頁數較多，轉換可能需要較長時間，請勿關閉頁面', 'info');
                }
                
                // 計算最優化的解析度和品質
                const scale = totalPages > 80 ? 1.0 : (totalPages > 40 ? 1.2 : 1.5);
                const quality = totalPages > 80 ? 0.7 : (totalPages > 40 ? 0.8 : 0.9);
                
                for (let i = 1; i <= totalPages; i++) {
                    try {
                        // 定期釋放記憶體（每10頁）
                        if (i % 10 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 30)); // 短暫暫停讓瀏覽器回收記憶體
                        }
                        
                        // 更新進度
                        const progress = Math.round((i / totalPages) * 100);
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `正在轉換第 ${i} / ${totalPages} 頁...`;
                        
                        // 取得頁面
                        const page = await pdfDocument.getPage(i);
                        
                        // 設定渲染選項 - 根據頁數調整解析度
                        const viewport = page.getViewport({ scale: scale });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        // 渲染頁面到 canvas
                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                        
                        // 將 canvas 轉為圖片 URL (根據頁數調整品質)
                        const imgUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // 新增投影片並加入圖片
                        const slide = pptx.addSlide();
                        
                        // 計算圖片在投影片中的尺寸和位置
                        const slideWidth = 10; // 投影片寬度 (英吋)
                        const slideHeight = 5.625; // 投影片高度 (英吋)
                        const imgRatio = canvas.width / canvas.height;
                        
                        let imgWidth, imgHeight, imgX, imgY;
                        
                        if (imgRatio > slideWidth / slideHeight) {
                            // 圖片較寬，以寬度為基準
                            imgWidth = slideWidth;
                            imgHeight = slideWidth / imgRatio;
                            imgX = 0;
                            imgY = (slideHeight - imgHeight) / 2;
                        } else {
                            // 圖片較高，以高度為基準
                            imgHeight = slideHeight;
                            imgWidth = slideHeight * imgRatio;
                            imgX = (slideWidth - imgWidth) / 2;
                            imgY = 0;
                        }
                        
                        // 將圖片加入投影片
                        slide.addImage({
                            data: imgUrl,
                            x: imgX,
                            y: imgY,
                            w: imgWidth,
                            h: imgHeight
                        });
                        
                        // 立即釋放記憶體
                        page.cleanup();
                        canvas.width = 0;
                        canvas.height = 0;
                        
                        successPages++;
                        
                        // 如果頁數很多，分批處理
                        if (totalPages > 50 && i % 20 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                        
                    } catch (pageError) {
                        console.error(`處理第 ${i} 頁時發生錯誤:`, pageError);
                        failedPages++;
                        
                        // 即使轉換失敗，也建立一個空白投影片保持頁碼對應
                        try {
                            const slide = pptx.addSlide();
                            slide.addText(`第 ${i} 頁轉換失敗`, {
                                x: 0.5,
                                y: 2.5,
                                w: 9,
                                h: 1,
                                align: 'center',
                                color: 'FF0000',
                                fontSize: 24
                            });
                        } catch (e) {
                            console.error('建立錯誤頁失敗:', e);
                        }
                        
                        continue; // 跳過此頁，繼續下一頁
                    }
                }
                
                // 完成轉換
                progressFill.style.width = '100%';
                progressText.textContent = '轉換完成，正在生成檔案...';
                
                // 儲存 PPTX 檔案
                const outputFileName = `${fileName}_轉換.pptx`;
                await pptx.writeFile({ fileName: outputFileName });
                
                // 顯示成功訊息
                let resultMessage = `轉換完成！已下載檔案：${outputFileName}`;
                if (failedPages > 0) {
                    resultMessage += ` (成功: ${successPages} 頁, 失敗: ${failedPages} 頁)`;
                } else {
                    resultMessage += ` (共 ${successPages} 頁)`;
                }
                
                showStatus(resultMessage, failedPages > 0 ? 'info' : 'success');
                
                // 啟用按鈕
                convertBtn.disabled = false;
                clearBtn.disabled = false;
                
            } catch (error) {
                console.error('轉換失敗:', error);
                showStatus(`轉換失敗: ${error.message}`, 'error');
                
                // 啟用按鈕
                convertBtn.disabled = false;
                clearBtn.disabled = false;
            }
        }
        
        // 清除檔案
        function clearFile() {
            fileInput.value = '';
            pdfDocument = null;
            pdfImages = [];
            fileName = '';
            
            fileInfo.textContent = '尚未選擇檔案';
            previewSection.style.display = 'none';
            progressContainer.style.display = 'none';
            statusMessage.style.display = 'none';
            
            convertBtn.disabled = false;
            clearBtn.disabled = false;
        }
        
        // 顯示狀態訊息
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status';
            
            if (type === 'success') {
                statusMessage.classList.add('success');
            } else if (type === 'error') {
                statusMessage.classList.add('error');
            } else if (type === 'info') {
                statusMessage.classList.add('info');
            }
            
            statusMessage.style.display = 'block';
            
            // 自動隱藏成功/資訊訊息
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }
        
        // 格式化檔案大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('準備就緒，請上傳 PDF 檔案開始轉換', 'success');
        });
    </script>
</body>
</html>
